<html>
    <head>
        <title>Single AR.js frame</title>
        <script src="https://aframe.io/releases/1.1.0/aframe.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

        <!-- Add billboard a-frame component to have text labels face camera at all times -->
        <script src="https://rawgit.com/blairmacintyre/aframe-look-at-billboard-component/master/dist/aframe-look-at-billboard-component.min.js"></script>

        <script src="video-camera.js"></script>
        <script src="video-arjs.js"></script>
        <script src="video-race.js"></script>
        <link rel="stylesheet" href="video.css"/>
    </head>
    <body>
        <div>
            <!-- At the moment video viewport can't be resized in AR.js https://github.com/AR-js-org/AR.js/issues/15 -->
            <!--
                AR.js has many undocumented settings, for example ARjs.Profile.prototype.performance defines canvas
                size with default 'desktop-normal' being 640x480 and maxDetectionRate 60. Alternative fast profile is
                called 'phone-slow' and has lower canvas resolution which results in 30-50% lower detection distance,
                but 30-50% more fps.

                AR.js acts as listener for A-Frame framework and performs work every time A-Frame tries to draw the
                frame. It can be seen in Chrome dev tools Performance tab stack. Seems AR.js performs detection only
                on some frames based on maxDetectionRate. After our tests we found out that lower maxDetectionRate
                dramatically improves fps and seems to result in less missed markers.

                Since usb video receivers output 640x480 and original PAL resolution is 720x576 desktop-normal profile
                with maxDetectionRate of 10 should be optimal. On a fast PC it gives about 20-25 fps with 4 videos on
                screen and phone-slow don't really add that much with 4 videos, but in reality - not much difference
                between the two so either can be used.

                TODO There is a degradation of performance after a long run. Sometimes eveything is slow (15fps) right
                away and closing other unrelated browser tabs helps - needs research.

                To check performance - add 'stats' attribute on <a-scene> - it will draw debug info.

                Pattern ratio is white marker area side length divided by black side length and is 0.66 for TinyViewPlus
                ArUco markers. Seems no difference between 0.5 and 0.66 - the algorithm just needs a thick black border
                around the marker itself.

                It seems that number of markers don't affect detection performance.
             -->
            <a-scene arjs='detectionMode: mono; performanceProfile: phone-slow; maxDetectionRate: 10; patternRatio: 0.66' vr-mode-ui="enabled: false;">
                <!--
                For testing purposes we can record screen, put it to ./video.webm and load this page
                with different marker settings to see if it enhances detection
                -->
            <!--<a-scene arjs='detectionMode: mono_and_matrix; matrixCodeType: 4x4_BCH_13_9_3; sourceType: video; sourceUrl: video.webm' vr-mode-ui="enabled: false;">-->

                <a-marker preset="pattern" type="pattern" url="markers/tinyviewplus-marker_00_main_a.patt" showdistance finishmarker>

                    <a-box color="blue" depth="1" height="1" width="1" opacity="0.5"></a-box>
                    <a-text value="Hello world" font="roboto" width="40" transparent="false" billboard></a-text>

                </a-marker>

                <a-marker preset="pattern" type="pattern" url="markers/tinyviewplus-marker_01_main_b.patt" showdistance finishmarker>

                    <a-box color="green" depth="1" height="1" width="1" opacity="0.5"></a-box>
                    <a-text value="Hello world" font="roboto" width="40" transparent="false" billboard></a-text>

                </a-marker>

                <a-marker preset="pattern" type="pattern" url="markers/tinyviewplus-marker_02_main_c.patt" showdistance finishmarker>

                    <a-box color="yellow" depth="1" height="1" width="1" opacity="0.5"></a-box>
                    <a-text value="Hello world" font="roboto" width="40" transparent="false" billboard></a-text>

                </a-marker>

                <a-marker preset="pattern" type="pattern" url="markers/tinyviewplus-marker_03_main_d.patt" showdistance finishmarker>

                    <a-box color="pink" depth="1" height="1" width="1" opacity="0.5"></a-box>
                    <a-text value="Hello world" font="roboto" width="40" transparent="false" billboard></a-text>

                </a-marker>

                <a-entity camera></a-entity>
            </a-scene>
        </div>

        <div class="video-panel">
            <div class="video-option">
                <div class="video-option-name">Camera:</div>
                <select id="cameraDevice" style="width: 230px" onchange="onCameraSelected()">
                </select>
            </div>

            <div class="video-option">
                <div class="video-option-name">Pilot name:</div>
                <input id="pilotName" type="text" value="Pilot1" size="26">
            </div>
        </div>
    </body>
</html>
